    <!DOCTYPE html>
    <html lang="en" class="scroll-smooth">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Dashboard - SKYNET Automation</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
        <script src="https://unpkg.com/lucide-icons@latest/dist/umd/lucide.js"></script>
        <style>
            body { font-family: 'Inter', sans-serif; background-color: #000000; color: #F3F4F6; }
            .gradient-text { background: linear-gradient(90deg, #38bdf8, #a78bfa, #f472b6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }
            .dashboard-card { background-color: rgba(31, 41, 55, 0.3); border: 1px solid rgba(75, 85, 99, 0.5); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
            .form-textarea { background-color: rgba(31, 41, 55, 0.5); border: 1px solid #4b5563; transition: border-color 0.2s; }
            .form-textarea:focus { border-color: #38bdf8; outline: none; box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.4); }
            .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #38bdf8; width: 24px; height: 24px; animation: spin 1s ease-in-out infinite; }
            @keyframes spin { to { transform: rotate(360deg); } }
        </style>
    </head>
    <body class="antialiased">

        <!-- === HEADER === -->
        <header class="sticky top-0 z-50 bg-black/80 backdrop-blur-sm border-b border-gray-800">
            <div class="container mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="text-2xl font-bold tracking-wider"><a href="index.html">SKYNET</a></div>
                    <nav class="hidden md:flex items-center space-x-8">
                        <a href="services.html" class="hover:text-sky-400 transition-colors">Services</a>
                        <a href="process.html" class="hover:text-sky-400 transition-colors">Our Process</a>
                        <a href="contact.html" class="hover:text-sky-400 transition-colors">Contact</a>
                    </nav>
                    <div class="flex items-center space-x-4">
                        <a href="#" id="sign-out-btn" class="text-sm hover:text-red-400 transition-colors">Sign Out</a>
                    </div>
                </div>
            </div>
        </header>

        <main class="py-20">
            <div class="container mx-auto px-6">
                <h1 class="text-4xl md:text-5xl font-bold mb-12">Automation <span class="gradient-text">Dashboard</span></h1>

                <!-- Instagram Automation Card -->
                <div class="dashboard-card max-w-2xl mx-auto rounded-2xl p-8">
                    <div class="flex items-center gap-4 mb-6">
                        <i data-lucide="instagram" class="w-8 h-8 text-pink-400"></i>
                        <h2 class="text-3xl font-bold">Instagram Auto-Poster</h2>
                    </div>

                    <!-- STEP 1: User sees this first. They need to connect their account. -->
                    <div id="insta-disconnected">
                        <p class="text-gray-400 mb-6">To get started, connect your Instagram account. This will redirect you to Instagram to securely authorize SKYNET to post on your behalf.</p>
                        <button id="connect-insta-btn" class="w-full flex items-center justify-center gap-3 py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-gradient-to-r from-pink-500 to-orange-500 hover:opacity-90 transition-opacity">
                            <i data-lucide="link"></i>
                            Connect with Instagram
                        </button>
                    </div>

                    <!-- STEP 2: This section is hidden until the user successfully connects their account. -->
                    <div id="insta-connected" class="hidden">
                        <div class="bg-emerald-900/50 border border-emerald-500 text-emerald-300 px-4 py-3 rounded-lg mb-6 flex items-center gap-3">
                            <i data-lucide="check-circle"></i>
                            <!-- The username would be dynamically inserted by your backend -->
                            <span>Instagram Account Connected: <strong id="insta-username">@bolzy99</strong></span> <!-- Hardcoded for testing -->
                        </div>

                        <form id="insta-post-form">
                            <label for="intent" class="block text-sm font-medium text-gray-300 mb-2">Describe your post intent:</label>
                            <textarea id="intent" name="intent" rows="5" class="form-textarea w-full rounded-md p-3 text-lg" placeholder="e.g., 'Create a motivational post about overcoming challenges with a picture of a mountain at sunrise.'"></textarea>
                            
                            <div class="mt-6">
                                <button type="submit" class="w-full flex items-center justify-center gap-3 py-3 px-4 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-sky-500 hover:bg-sky-600 transition-colors">
                                    <span id="button-text">Generate & Post to Instagram</span>
                                    <div id="loading-spinner" class="spinner hidden"></div>
                                </button>
                            </div>
                        </form>
                        
                        <div id="status-message" class="mt-6 text-center text-lg"></div>
                    </div>
                </div>
            </div>
        </main>

        <script>
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }

            // --- UI Elements ---
            const disconnectedView = document.getElementById('insta-disconnected');
            const connectedView = document.getElementById('insta-connected');
            const connectButton = document.getElementById('connect-insta-btn');
            const postForm = document.getElementById('insta-post-form');
            const statusMessage = document.getElementById('status-message');
            const buttonText = document.getElementById('button-text');
            const spinner = document.getElementById('loading-spinner');
            const instaUsernameSpan = document.getElementById('insta-username');
            const signOutButton = document.getElementById('sign-out-btn');

            // --- Function to update UI based on connection status ---
            function updateInstagramUI(isConnected, username = '') {
                if (isConnected) {
                    disconnectedView.classList.add('hidden');
                    connectedView.classList.remove('hidden');
                    instaUsernameSpan.textContent = `@${username}`;
                } else {
                    disconnectedView.classList.remove('hidden');
                    connectedView.classList.add('hidden');
                    instaUsernameSpan.textContent = '';
                }
            }

            // --- Check URL parameters on page load ---
            const urlParams = new URLSearchParams(window.location.search);
            const authStatus = urlParams.get('status');
            const authCode = urlParams.get('code');
            const authErrorMessage = urlParams.get('message');

            let isUserConnected = sessionStorage.getItem('instagramConnected') === 'true';
            let connectedUsername = sessionStorage.getItem('instagramUsername') || 'bolzy99'; // Default for testing

            if (authStatus === 'success' && authCode) {
                // User just successfully authorized via Meta
                isUserConnected = true;
                // In a real app, you'd fetch the actual username from your backend after token exchange
                // For now, we'll use a placeholder or the test username
                connectedUsername = 'bolzy99'; 
                sessionStorage.setItem('instagramConnected', 'true');
                sessionStorage.setItem('instagramUsername', connectedUsername);
                statusMessage.textContent = 'Instagram connected successfully!';
                statusMessage.classList.add('text-emerald-400');
                // Clear the URL parameters to prevent re-processing on refresh
                window.history.replaceState({}, document.title, window.location.pathname); 

            } else if (authStatus === 'error') {
                statusMessage.textContent = `Connection failed: ${decodeURIComponent(authErrorMessage || 'Unknown error')}`;
                statusMessage.classList.add('text-red-400');
                sessionStorage.setItem('instagramConnected', 'false');
                sessionStorage.removeItem('instagramUsername');
                // Clear the URL parameters
                window.history.replaceState({}, document.title, window.location.pathname);
            }

            // Update UI based on current state
            updateInstagramUI(isUserConnected, connectedUsername);

            // --- OAUTH FLOW TRIGGER ---
            connectButton.addEventListener('click', () => {
                // IMPORTANT: Replace 'YOUR_FACEBOOK_APP_ID' with your actual App ID from Meta Developers
                const appId = '1034637958867552'; 
                // IMPORTANT: Replace 'https://your-site.netlify.app/auth/callback.html' with the exact Redirect URI you added in Meta Developers
                // If testing locally, use 'http://localhost:5500/auth/callback.html' or your local server's address
                const redirectUri = 'https://deskill.netlify.app/auth/callback.html'; // Changed to .html as per common practice

                // These are the permissions your app is requesting from the user
                const scope = 'pages_show_list,instagram_basic,instagram_content_publish';

                // Construct the full OAuth URL
                const authUrl = `https://www.facebook.com/v18.0/dialog/oauth?client_id=${appId}&redirect_uri=${redirectUri}&scope=${scope}&response_type=code`;

                // Redirect the user to Meta's authorization page
                window.location.href = authUrl;
            });


            // --- Instagram Posting Logic ---
            postForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                buttonText.textContent = 'Generating...';
                spinner.classList.remove('hidden');
                statusMessage.textContent = ''; // Clear previous status

                const intent = document.getElementById('intent').value;

                if (!intent) {
                    statusMessage.textContent = 'Please describe your post intent.';
                    statusMessage.classList.remove('text-emerald-400', 'text-red-400');
                    statusMessage.classList.add('text-yellow-400');
                    buttonText.textContent = 'Generate & Post to Instagram';
                    spinner.classList.add('hidden');
                    return;
                }

                // In a real scenario, you would send the 'intent' and the stored
                // Instagram access token/ID to your n8n workflow.
                // For now, we'll simulate the AI generation and posting.

                try {
                    // Simulate API call to n8n workflow for content generation and posting
                    // Replace 'YOUR_N8N_WEBHOOK_URL' with your actual n8n webhook URL
                    const n8nWebhookUrl = 'YOUR_N8N_WEBHOOK_URL'; 
                    // You would also send the user's instagram token/ID from sessionStorage or a more secure backend store
                    const response = await fetch(n8nWebhookUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            intent: intent,
                            // In a real app, you'd retrieve the actual Instagram token/ID here
                            // For testing, n8n might use a hardcoded one or one obtained from a previous manual step
                            instagramAccessToken: sessionStorage.getItem('instagramAccessToken'), // Placeholder
                            instagramBusinessId: sessionStorage.getItem('instagramBusinessId') // Placeholder
                        }),
                    });

                    if (response.ok) {
                        const result = await response.json();
                        statusMessage.textContent = `Post generated and sent to Instagram! Message: ${result.message || 'Success'}`;
                        statusMessage.classList.remove('text-red-400', 'text-yellow-400');
                        statusMessage.classList.add('text-emerald-400');
                        document.getElementById('intent').value = ''; // Clear textarea
                    } else {
                        const errorData = await response.json();
                        statusMessage.textContent = `Error posting: ${errorData.message || response.statusText}`;
                        statusMessage.classList.remove('text-emerald-400', 'text-yellow-400');
                        statusMessage.classList.add('text-red-400');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    statusMessage.textContent = 'An unexpected error occurred. Please try again.';
                    statusMessage.classList.remove('text-emerald-400', 'text-yellow-400');
                    statusMessage.classList.add('text-red-400');
                } finally {
                    buttonText.textContent = 'Generate & Post to Instagram';
                    spinner.classList.add('hidden');
                }
            });

            // --- Sign Out Logic ---
            signOutButton.addEventListener('click', (event) => {
                event.preventDefault();
                sessionStorage.removeItem('instagramConnected');
                sessionStorage.removeItem('instagramUsername');
                sessionStorage.removeItem('instagramAccessToken'); // Clear any stored tokens
                sessionStorage.removeItem('instagramBusinessId'); // Clear any stored IDs
                window.location.href = 'index.html'; // Redirect to home or sign-in page
            });

        </script>
    </body>
    </html>
