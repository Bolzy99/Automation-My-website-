<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - SKYNET Automation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide-icons@latest/dist/umd/lucide.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #000000; color: #F3F4F6; }
        .gradient-text { background: linear-gradient(90deg, #38bdf8, #a78bfa, #f472b6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; }
        .dashboard-card { background-color: rgba(17, 24, 39, 0.8); border: 1px solid rgba(55, 65, 81, 0.7); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        .spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-radius: 50%; border-top-color: #38bdf8; width: 24px; height: 24px; animation: spin 1s ease-in-out infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Styles for the feature buttons */
        .feature-card {
            @apply relative rounded-2xl overflow-hidden cursor-pointer transition-all duration-300 ease-in-out;
            background-size: cover;
            background-position: center;
            min-height: 220px;
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.1);
        }
        .feature-card:before {
            content: '';
            @apply absolute inset-0 transition-all duration-300;
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.1) 60%);
        }
        .feature-card:hover:before {
            background: linear-gradient(to top, rgba(0,0,0,0.9) 0%, rgba(0,0,0,0.3) 70%);
        }
        .feature-card:hover {
            transform: scale(1.03);
            box-shadow: 0 8px 30px rgba(56, 189, 248, 0.3), inset 0 0 0 1px rgba(255, 255, 255, 0.2);
        }
        .feature-content {
            @apply absolute bottom-0 left-0 right-0 p-6 text-left;
        }
        .feature-content h3 {
            @apply text-2xl font-black tracking-tight text-white;
        }
        .feature-content p {
            @apply text-gray-300 text-sm mt-1;
        }

        /* Modal Styles */
        .modal-overlay {
            @apply fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center transition-opacity duration-300 opacity-0 pointer-events-none z-50;
        }
        .modal-container {
            @apply bg-gray-900 border border-gray-700 rounded-2xl shadow-2xl w-full max-w-2xl m-4 p-8 transition-all duration-300 transform scale-95 opacity-0;
        }
        .modal-overlay.active {
            @apply opacity-100 pointer-events-auto;
        }
        .modal-overlay.active .modal-container {
            @apply scale-100 opacity-100;
        }
        .form-textarea { background-color: rgba(31, 41, 55, 0.5); border: 1px solid #4b5563; }
        .form-textarea:focus { border-color: #38bdf8; outline: none; box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.4); }
    </style>
</head>
<body class="antialiased">

    <!-- === HEADER === -->
    <header class="sticky top-0 z-40 bg-black/80 backdrop-blur-sm border-b border-gray-800">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="text-2xl font-bold tracking-wider"><a href="index.html">SKYNET</a></div>
                <nav class="hidden md:flex items-center space-x-8">
                    <a href="services.html" class="hover:text-sky-400 transition-colors">Services</a>
                    <a href="process.html" class="hover:text-sky-400 transition-colors">Our Process</a>
                    <a href="contact.html" class="hover:text-sky-400 transition-colors">Contact</a>
                </nav>
                <div class="flex items-center space-x-4">
                    <a href="#" id="sign-out-btn" class="text-sm hover:text-red-400 transition-colors">Sign Out</a>
                </div>
            </div>
        </header>

    <main class="py-20">
        <div class="container mx-auto px-6">
            <h1 class="text-4xl md:text-5xl font-black mb-4">Automation <span class="gradient-text">Dashboard</span></h1>
            <p class="text-lg text-gray-400 mb-12">Welcome, Bolzy. Initiate your automated workflows below.</p>

            <!-- Loading State: Shown briefly on page load -->
            <div id="loading-state" class="dashboard-card max-w-4xl mx-auto rounded-2xl p-8 text-center">
                 <div class="spinner mx-auto"></div>
                 <p class="mt-4 text-gray-400">Checking connection status...</p>
            </div>

            <!-- Instagram Connection Status -->
            <div id="insta-disconnected" class="dashboard-card max-w-4xl mx-auto rounded-2xl p-8 text-center hidden">
                <i data-lucide="instagram" class="w-12 h-12 text-pink-400 mx-auto mb-4"></i>
                <h2 class="text-2xl font-bold mb-2">Connect Your Instagram Account</h2>
                <p class="text-gray-400 mb-6 max-w-xl mx-auto">To access the Automation Hub, please connect your Instagram account. This will redirect you to Facebook to securely authorize SKYNET.</p>
                <button id="connect-insta-btn" class="inline-flex items-center justify-center gap-3 py-3 px-8 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-gradient-to-r from-pink-500 to-orange-500 hover:opacity-90 transition-opacity">
                    <i data-lucide="link"></i>
                    Connect with Instagram
                </button>
            </div>

            <!-- Main Dashboard - Shown when connected -->
            <div id="insta-connected" class="hidden">
                <div class="dashboard-card max-w-6xl mx-auto rounded-2xl p-8 mb-12">
                     <div class="flex flex-col md:flex-row items-center justify-between">
                        <div class="flex items-center gap-4 text-center md:text-left">
                            <i data-lucide="check-circle" class="w-10 h-10 text-emerald-400 flex-shrink-0"></i>
                            <div>
                                <h2 class="text-2xl font-bold">Instagram Automation Hub</h2>
                                <p class="text-emerald-400">Account Connected: <strong id="insta-username"></strong></p>
                            </div>
                        </div>
                        <div class="grid grid-cols-3 gap-4 text-center mt-6 md:mt-0">
                            <div class="p-3 bg-black/20 rounded-lg"><p class="text-xl font-bold text-sky-400" id="insta-posts-count">0</p><p class="text-gray-400 text-xs">Posts</p></div>
                            <div class="p-3 bg-black/20 rounded-lg"><p class="text-xl font-bold text-purple-400" id="insta-followers-count">0</p><p class="text-gray-400 text-xs">Followers</p></div>
                            <div class="p-3 bg-black/20 rounded-lg"><p class="text-xl font-bold text-pink-400" id="insta-following-count">0</p><p class="text-gray-400 text-xs">Following</p></div>
                        </div>
                    </div>
                </div>

                <div class="max-w-6xl mx-auto">
                    <h3 class="text-3xl font-bold mb-8 text-center">Select a Workflow to Initiate</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                        <div class="feature-card" data-feature="post-upload" style="background-image: url('assets/post-upload-bg.jpg');">
                            <div class="feature-content"><h3>Content Generation Engine</h3><p>AI-powered image and caption creation for posts.</p></div>
                        </div>
                        <div class="feature-card" data-feature="reel-upload" style="background-image: url('assets/reel-upload-bg.jpg');">
                            <div class="feature-content"><h3>Viral Reel Synthesizer</h3><p>Automated creation and deployment of short-form video.</p></div>
                        </div>
                        <div class="feature-card" data-feature="chat-replier" style="background-image: url('assets/chat-replier-bg.jpg');">
                            <div class="feature-content"><h3>Engagement AI Matrix</h3><p>Intelligent, automated responses for DMs and comments.</p></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal Dialog for Intent -->
    <div id="intent-modal" class="modal-overlay">
        <div class="modal-container">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modal-title" class="text-3xl font-bold gradient-text">Initiate Workflow</h2>
                <button id="close-modal-btn" class="text-gray-400 hover:text-white transition-colors"><i data-lucide="x" class="w-8 h-8"></i></button>
            </div>
            <p id="modal-instructions" class="text-gray-300 mb-4 text-lg"></p>
            <form id="intent-form">
                <textarea id="intent-textarea" rows="6" class="form-textarea w-full rounded-md p-4 text-lg" placeholder="Describe your intent here..."></textarea>
                <input type="hidden" id="feature-type-input">
                <div id="modal-status-message" class="mt-4 text-center text-lg"></div>
                <div class="mt-6 flex justify-end">
                    <button type="submit" class="w-full md:w-auto flex items-center justify-center gap-3 py-3 px-8 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-sky-500 hover:bg-sky-600 transition-colors">
                        <span id="modal-button-text">Execute Automation</span>
                        <div id="modal-spinner" class="spinner hidden"></div>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // --- UI Elements ---
        const loadingState = document.getElementById('loading-state');
        const disconnectedView = document.getElementById('insta-disconnected');
        const connectedView = document.getElementById('insta-connected');
        const connectButton = document.getElementById('connect-insta-btn');
        const instaUsernameSpan = document.getElementById('insta-username');
        const signOutButton = document.getElementById('sign-out-btn');
        const instaPostsCount = document.getElementById('insta-posts-count');
        const instaFollowersCount = document.getElementById('insta-followers-count');
        const instaFollowingCount = document.getElementById('insta-following-count');
        const featureCards = document.querySelectorAll('.feature-card');
        
        // Modal Elements
        const modal = document.getElementById('intent-modal');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const modalTitle = document.getElementById('modal-title');
        const modalInstructions = document.getElementById('modal-instructions');
        const intentForm = document.getElementById('intent-form');
        const intentTextarea = document.getElementById('intent-textarea');
        const featureTypeInput = document.getElementById('feature-type-input');
        const modalStatusMessage = document.getElementById('modal-status-message');
        const modalButtonText = document.getElementById('modal-button-text');
        const modalSpinner = document.getElementById('modal-spinner');

        // --- Modal & Feature Data ---
        const featureData = {
            'post-upload': {
                title: 'Content Generation Engine',
                instructions: 'Describe the image you want the AI to generate and the core message of your post. The system will create a visually stunning image and a compelling caption, then upload it directly to your Instagram feed.'
            },
            'reel-upload': {
                title: 'Viral Reel Synthesizer',
                instructions: 'Provide a topic or a script outline. The AI will generate a short, engaging video reel with appropriate visuals and audio, optimized for viral potential and ready for deployment.'
            },
            'chat-replier': {
                title: 'Engagement AI Matrix',
                instructions: 'Define the rules for your automated responses. Specify keywords, question types, and the desired tone. The AI will handle DMs and comments, ensuring no lead or interaction is missed.'
            }
        };

        // --- Core Logic ---
        function updateInstagramUI(isConnected, username, posts, followers, following) {
            // Hide the loading state first
            loadingState.classList.add('hidden');

            if (isConnected) {
                disconnectedView.classList.add('hidden');
                connectedView.classList.remove('hidden');
                instaUsernameSpan.textContent = `@${username}`;
                instaPostsCount.textContent = (posts || 0).toLocaleString();
                instaFollowersCount.textContent = (followers || 0).toLocaleString();
                instaFollowingCount.textContent = (following || 0).toLocaleString();
            } else {
                disconnectedView.classList.remove('hidden');
                connectedView.classList.add('hidden');
            }
        }

        function openModal(feature) {
            const data = featureData[feature];
            if (!data) return;

            modalTitle.textContent = data.title;
            modalInstructions.textContent = data.instructions;
            featureTypeInput.value = feature;
            intentTextarea.value = '';
            modalStatusMessage.textContent = '';
            modal.classList.add('active');
        }

        function closeModal() {
            modal.classList.remove('active');
        }

        // --- Event Listeners ---
        connectButton.addEventListener('click', () => {
            const appId = '1034637958867552'; 
            const redirectUri = 'https://deskill.netlify.app/auth/callback.html'; 
            const scope = 'pages_show_list,instagram_basic,instagram_content_publish,pages_read_engagement';
            const authUrl = `https://www.facebook.com/v18.0/dialog/oauth?client_id=${appId}&redirect_uri=${redirectUri}&scope=${scope}&response_type=code`;
            window.location.href = authUrl;
        });

        signOutButton.addEventListener('click', (e) => {
            e.preventDefault();
            sessionStorage.clear();
            window.location.href = 'index.html';
        });

        featureCards.forEach(card => {
            card.addEventListener('click', () => {
                openModal(card.dataset.feature);
            });
        });

        closeModalBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal();
        });
        
        intentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const intent = intentTextarea.value;
            const feature = featureTypeInput.value;

            if (!intent.trim()) {
                modalStatusMessage.textContent = 'Please provide your instructions.';
                modalStatusMessage.className = 'mt-4 text-center text-lg text-yellow-400';
                return;
            }

            modalButtonText.classList.add('hidden');
            modalSpinner.classList.remove('hidden');
            modalStatusMessage.textContent = 'Executing... Please wait.';
            modalStatusMessage.className = 'mt-4 text-center text-lg text-gray-400';

            // --- N8N Webhook Call ---
            const n8nWebhookUrl = 'YOUR_N8N_WEBHOOK_URL_HERE';
            const accessToken = sessionStorage.getItem('instagramAccessToken');
            const businessId = sessionStorage.getItem('instagramBusinessId');

            try {
                // Simulate n8n call
                await new Promise(resolve => setTimeout(resolve, 2500));
                
                modalStatusMessage.textContent = 'Workflow initiated successfully!';
                modalStatusMessage.className = 'mt-4 text-center text-lg text-emerald-400';
                setTimeout(closeModal, 2000);

            } catch (error) {
                modalStatusMessage.textContent = 'An error occurred. Please try again.';
                modalStatusMessage.className = 'mt-4 text-center text-lg text-red-400';
            } finally {
                modalButtonText.classList.remove('hidden');
                modalSpinner.classList.add('hidden');
            }
        });

        // --- Initial Page Load Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const authStatus = urlParams.get('status');
            
            if (authStatus === 'success') {
                sessionStorage.setItem('instagramConnected', 'true');
                sessionStorage.setItem('instagramUsername', 'bolzy99');
                sessionStorage.setItem('instagramPosts', '125');
                sessionStorage.setItem('instagramFollowers', '5500');
                sessionStorage.setItem('instagramFollowing', '90');
                window.history.replaceState({}, document.title, window.location.pathname);
            }

            const isConnected = sessionStorage.getItem('instagramConnected') === 'true';
            
            // **FIX:** The logic is now more direct, removing the problematic timeout.
            updateInstagramUI(
                isConnected,
                sessionStorage.getItem('instagramUsername'),
                sessionStorage.getItem('instagramPosts'),
                sessionStorage.getItem('instagramFollowers'),
                sessionStorage.getItem('instagramFollowing')
            );
        });

    </script>
</body>
</html>
